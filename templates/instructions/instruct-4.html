<div id="container-instructions">
  <h1>
    Instructions
    <button type="button" id="next" value="next" disabled
      class="btn btn-primary btn-lg continue pull-right">
      Next <span class="glyphicon glyphicon-arrow-right"></span>
    </button>
    <button type="button" id="next" value="next" disabled
      class="btn btn-primary btn-lg previous pull-right">
      <span class="glyphicon glyphicon-arrow-left"></span> Previous 
    </button>
  </h1>
  <hr>
  <div class="instructions well">
    <p>
    After you select the words that you think complete the elephant's thought,
    the elephant will react. Like all elephants, it enjoys being understood,
    and resents being misunderstood. So if you correctly identify the
    remainder of the sentence, you'll see the elephant jump up and down;
    otherwise, you'll see its eyes roll. Either way, the elephant will
    finish its own sentence the way it intended all along.
    </p>
    <p>
    Click either character below to see a sentence. When you interrupt, select
    "pa", "bo", "gu" to see the elephant react positively. Then click either
    character again to start the trial over, but this time when you interrupt,
    select "gu", "bo", "pa" to see the elephant react negatively.
    </p>
    <div id="democontainer" style="overflow: hidden;">
      <div id="demostage" style="overflow: auto; padding-bottom: 4.6em;">
        <div class="cow" style="padding-top: 7em;">
          <svg width="160" height="160">
            <image xlink:href="static/images/cow.svg"
              width="160" height="120" y=40 />
          </svg>
        </div>
        <div class="stim inst-stim hidden">
          <div> </div>
        </div>
        <div class="response inst-response hidden">
          <div> </div>
        </div>
      </div>
      <div id="syl-drawer" class="hidden" style="padding-bottom: 1em;">
      </div>
    </div>
  </div>
  <!-- <hr> -->
  <!-- <div class="instructionsnav"> -->
  <!--   <div class="row"> -->
  <!--     <div class="col-xs-2"> -->
  <!--       <button type="button" id="next" value="next" -->
  <!--         class="btn btn-primary btn-lg previous"> -->
  <!--         <span class="glyphicon glyphicon-arrow-left"></span> Previous -->
  <!--       </button> -->
  <!--     </div> -->
  <!--     <div class="col-xs-8"> -->
  <!--     </div> -->
  <!--     <div class="col-xs-2"> -->
  <!--       <button type="button" id="next" value="next" -->
  <!--         class="btn btn-primary btn-lg continue pull-right"> -->
  <!--         Next <span class="glyphicon glyphicon-arrow-right"></span> -->
  <!--       </button> -->
  <!--     </div> -->
  <!--   </div> -->
  <!-- </div> -->
  <!-- <script src="/static/lib/d3-min.js" type="text/javascript"> </script> -->
  <script type="text/javascript">
    var demodrawsyl = function(bubble, syl) {
      var s = demo_syl_code[syl] || " ";
      bubble.select("div")
            .append("p")
            .attr("class", "white")
            .text(s);
    };
    var demoshowsyl = function(bubble) {
      bubble.select(".white")
            .classed("white", false)
            .style("color", "#606388");
    };
    var demoshowbubble = function(bubble) {
      bubble.classed("hidden", false);
    };
    var demohidebubble = function(bubble) {
      bubble.classed("hidden", true);
      bubble.selectAll("p").remove();
    };
    var demoshowdrawer = function(drawer) {
      drawer.classed("hidden", false);
    }
    var demohidedrawer = function(drawer) {
      drawer.classed("hidden", true);
      drawer.selectAll("button").remove();
    }
    var demointerrupt = function(syls, callback) {
      var clicks = 0;
      var guess = [];
      demoshowbubble(rbubble);
      d3.select("#demostage")
        .style("padding-bottom", "1em");
      demoshowdrawer(demodrawer);
      demodrawer.selectAll("button")
                .data(syls)
                .enter()
                .insert("button")
                .attr("type", "button")
                .attr("class", "btn btn-default btn-lg")
                .text(function(d) { return demo_syl_code[d]; })
                .on("click",
                    function(d) {
                      guess.push(d);
                      demodrawsyl(rbubble, d);
                      if (clicks < conceal - 1) {
                        clicks++;
                      } else {
                        demodrawer.selectAll("button")
                                  .property("disabled", true);
                        callback(guess);
                      }
                    });
    };
    var democheck = function(drawer, guess, callback) {
      // callback here finishes the sequence, then starts next trial
      if (_.isEqual([0,1,2], guess)) {
        el.transition().duration(300).attr("transform", "translate(0,-50)")
          .transition().duration(300).attr("transform", "translate(0,0)")
          .transition().duration(300).attr("transform", "translate(0,-50)")
          .transition().duration(300).attr("transform", "translate(0,0)")
          .each("end", callback);
      } else {
        var lefteye = el.select("#path3163");
        var righteye = el.select("#path3161");
        lefteye
          .transition()
          .duration(2000)
          .ease("linear")
          .attrTween("transform", function () {
            return function (t) {
              var radius = 6;
              var t_angle = (4 * Math.PI) * t;
              var t_x = radius * Math.cos(t_angle);
              var t_y = radius * Math.sin(t_angle);
              return "translate(" + (t_x - 6) + "," + (t_y - 2) + ")";
            };
          })
          .transition()
          .duration(0)
          .attr("transform", "translate(0,0)");
         righteye
           .transition()
           .duration(2000)
           .ease("linear")
           .attrTween("transform", function () {
             return function (t) {
               var radius = 6;
               var t_angle = (4 * Math.PI) * t;
               var t_x = radius * Math.cos(t_angle + Math.PI);
               var t_y = radius * Math.sin(t_angle + Math.PI);
               return "translate(" + (t_x + 6) + "," + (t_y - 2) + ")";
             };
           })
           .transition()
           .duration(0)
           .attr("transform", "translate(0,0)")
           .each("end", function() { done = true; callback(); });
      }
    };
    var dodemosequence = function(sequence) {
      var cb = function() {
        var suffix = setInterval(function() {
          if (_.isEmpty(sequence)) {
            clearInterval(suffix);
            _.each([rbubble, sbubble], demohidebubble);
            demohidedrawer(demodrawer);
            d3.select("#demostage")
              .style("padding-bottom", "4.6em");
            if (done) { d3.selectAll("#next").property("disabled", false); }
          } else {
            var syl = sequence.shift();
            demoshowsyl(sbubble);
          }
        }, 500);
        return suffix;
      };
      var inter = 200;
      var prefix = setInterval(function() {
        if (203 - inter === 0) {
          clearInterval(prefix);
          demointerrupt(_.range(demo_syl_code.length),
                        function(guess) {
                          democheck(sequence, guess, cb)
                        });
        }
        else {
          var syl = sequence.shift();
          inter = inter + 1;
          demoshowsyl(sbubble);
        }
      }, 500);
      return prefix;
    };
    var el = d3.select("#demostage")
               .insert("div", ".cow")
               .attr("class", "elephant")
               .append("svg")
               .attr("width", 160)
               .attr("height", 160)
               .attr("viewBox", "0 0 360 344")
               .attr("preserveAspectRatio", "xMinYMin meet")
               .append("g")
               .attr("id", "elephant");
    d3.xml("static/images/elephant.svg", "image/svg+xml", function(xml) {
      var importedNode = document.importNode(xml.documentElement, true);
      importedNode.y.baseVal.value = 95;
      el.node().appendChild(importedNode);
    });
    var sbubble = d3.select(".stim");
    var rbubble = d3.select(".response");
    var conceal = 3;
    var demo_syl_code = ["wao", "yai", "piu", "shin", "bam", "fei", "ti", "ra", "ki"];
    var demodrawer = d3.select("#syl-drawer");
    var done = false;
    el.on("click", function() {
      demohidebubble(sbubble);
      demohidebubble(rbubble);
      demohidedrawer(demodrawer);
      setTimeout(function() {
        seq = [1,2,3,2,1,2,3];
        _.each(seq, _.partial(demodrawsyl, sbubble));
        demoshowbubble(sbubble);
        dodemosequence(seq);
      }, 500)
    });
  </script>
</div>
