<div id="container-instructions">
  <h1>
    Instructions
    <button type="button" id="next" value="next" disabled
      class="btn btn-primary btn-lg continue pull-right">
      Next <span class="glyphicon glyphicon-arrow-right"></span>
    </button>
    <button type="button" id="next" value="next"
      class="btn btn-primary btn-lg previous pull-right">
      <span class="glyphicon glyphicon-arrow-left"></span> Previous 
    </button>
  </h1>
  <hr>
  <div class="well">
    <p>
    As it happens, you, the cow, are rather excitable. Sometimes, you get so
    excited that you find yourself anticipating what the elephant is going to
    say. When this happens, you will see a speech bubble emerge from the cow's
    mouth, indicating that you have just interrupted the elephant
    mid-sentence. <b>Your goal is to predict the <span id="wrd"></span> of the
    sentence.</b> Click the button below to see what it looks like when you
    interrupt.
    </p>
    <div class="row">
      <div class="col-xs-12 text-center">
        <button type="button" id="startdemo" class="btn btn-default btn-lg">
          See sentences
        </button>
      </div>
    </div>
    <div id="democontainer" style="overflow: hidden;">
      <div id="demostage" style="overflow: auto; padding-bottom: 1.6em;">
        <div class="elephant" style="padding-top: 7em;">
          <svg width=160 height=160>
            <image xlink:href="static/images/elephant.svg"
              width=120 height=120 y=40 />
          </svg>
        </div>
        <div class="cow" style="padding-top: 7em;">
          <svg width="160" height="160">
            <image xlink:href="static/images/cow.svg"
              width="160" height="120" y=40 />
          </svg>
        </div>
        <div class="stim inst-stim hidden">
          <div> </div>
        </div>
        <div class="response inst-response hidden">
          <div> </div>
        </div>
      </div>
      <p id="followup" class="hidden">
      Every time you interrupt, you will be presented with a number,
      of possible continuations. <b>Click whichever
      <span id="wrd"></span>
      you think
      <span id="wrd"></span>
      to the
      <span id="wrd"></span>
      that the elphant will say next. Give it a try.</b>
      </p>
    </div>
  </div>
  <script type="text/javascript">
    var wrds = counterbalance === "0" ?
      ["next word", "button", "corresponds", "word"] :
      ["next three words", "buttons", "correspond", "words"];

    d3.selectAll("#wrd")
      .data(wrds)
      .text(_.identity);

    var demodrawsyl = function(bubble, syl) {
      var s = demo_syl_code[syl] || " ";
      bubble.select("div")
            .append("p")
            .attr("class", "white")
            .text(s);
    };
    var demoshowsyl = function(bubble) {
      bubble.select(".white")
            .classed("white", false)
            .style("color", "#606388");
    };
    var demoshowbubble = function(bubble) {
      bubble.classed("hidden", false);
    };
    var demohidebubble = function(bubble) {
      bubble.classed("hidden", true);
      bubble.selectAll("p").remove();
    };
    var demointerrupt = function(syls) {
      var clicks = 0;
      demoshowbubble(rbubble);
      var demodrawer = d3.select("#democontainer")
                         .insert("div", "#followup")
                         .attr("id", "syl-drawer")
                         .style("padding-bottom", "1em");
      demodrawer.selectAll("button")
                .data(syls)
                .enter()
                .insert("button")
                .attr("type", "button")
                .attr("class", "btn btn-default btn-lg")
                .text(function(d) { return demo_syl_code[d]; })
                .on("click",
                    function(d) {
                      demodrawsyl(rbubble, d);
                      if (clicks < conceal - 1) {
                        clicks++;
                      } else {
                        demodrawer.selectAll("button")
                                  .property("disabled", true);
                        d3.select(".continue")
                          .property("disabled", false);
                      }
                    });
      d3.select("#followup").classed("hidden", false);
    };
    var dodemosequence = function(sequence) {
      var inter = 200;
      var prefix = setInterval(function() {
        if (203 - inter === 0) {
          clearInterval(prefix);
          // this callback is demointerrupt
          demointerrupt(_.range(demo_syl_code.length));
        }
        else {
          var syl = sequence.shift();
          inter = inter + 1;
          demoshowsyl(sbubble);
        }
      }, 500);
      return prefix;
    };
    var el = d3.select(".elephant");
    var cow = d3.select(".cow");
    var sbubble = d3.select(".stim");
    var rbubble = d3.select(".response");
    var conceal = counterbalance === "0" ? 1 : 3;
    var demo_syl_code = ["wao", "yai", "piu", "shin", "bam", "fei", "ti", "ra", "ki"];
    var start = d3.select("#startdemo");
    start.on("click", function() {
      setTimeout(function() {
        var seq = [1,2,3,2,1,2,3];
        _.each(seq, _.partial(demodrawsyl, sbubble));
        demoshowbubble(sbubble);
        dodemosequence(seq);
      }, 500);
      start.property("disabled", true);
    });
  </script>
</div>
