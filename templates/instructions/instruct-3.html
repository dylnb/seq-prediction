<div id="container-instructions">
  <h1>Instructions</h1>
  <hr>
  <div class="instructions well">
    <p>
    As it happens, you, the cow, are rather excitable. In fact, every so often
    you get so excited you will find yourself anticipating what the elephant
    is going to say. When this happens, you will see a speech bubble emerge
    from the cow, indicating that you have just interrupted the elephant
    mid-sentence. Your goal is to finish the elephant's sentences correctly,
    exactly as the elephant intends to utter them. Click either character
    below to see what it will look like when you interrupt.
    </p>
    <div id="democontainer" style="overflow: hidden;">
      <div id="demostage" style="overflow: auto; padding-bottom: 1.6em;">
        <div class="elephant" style="padding-top: 7em;">
          <svg width=160 height=160>
            <image xlink:href="static/images/elephant.svg"
              width=120 height=120 y=40 />
          </svg>
        </div>
        <div class="cow" style="padding-top: 7em;">
          <svg width="160" height="160">
            <image xlink:href="static/images/cow.svg"
              width="160" height="120" y=40 />
          </svg>
        </div>
        <div class="stim inst-stim hidden">
          <div> </div>
        </div>
        <div class="response inst-response hidden">
          <div> </div>
        </div>
      </div>
    </div>
    <p>
    Every time you interrupt, you will be presented with a number of possible
    continuations. Click whichever button you think corresponds to the words
    that the elphant will say next. Give it a try.
  </div>
  <hr>
  <div class="instructionsnav">
    <div class="row">
      <div class="col-xs-2">
        <button type="button" id="next" value="next"
          class="btn btn-primary btn-lg previous">
          <span class="glyphicon glyphicon-arrow-left"></span> Previous
        </button>
      </div>
      <div class="col-xs-8">
      </div>
      <div class="col-xs-2">
        <button type="button" id="next" value="next"
          class="btn btn-primary btn-lg continue pull-right">
          Next <span class="glyphicon glyphicon-arrow-right"></span>
        </button>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    var demodrawsyl = function(bubble, syl) {
      var s = demo_syl_code[syl] || " ";
      bubble.select("div")
            .append("p")
            .attr("class", "white")
            .text(s);
    };
    var demoshowsyl = function(bubble) {
      bubble.select(".white")
            .classed("white", false)
            .style("color", "#606388");
    };
    var demoshowbubble = function(bubble) {
      bubble.classed("hidden", false);
    };
    var demohidebubble = function(bubble) {
      bubble.classed("hidden", true);
      bubble.selectAll("p").remove();
    };
    var demointerrupt = function(syls) {
      var clicks = 0;
      demoshowbubble(rbubble);
      var demodrawer = d3.select("#democontainer")
                         .append("div")
                         .attr("id", "syl-drawer")
                         .style("padding-bottom", "1em");
      demodrawer.selectAll("button")
                .data(syls)
                .enter()
                .insert("button")
                .attr("type", "button")
                .attr("class", "btn btn-default btn-lg")
                .text(function(d) { return demo_syl_code[d]; })
                .on("click",
                    function(d) {
                      demodrawsyl(rbubble, d);
                      if (clicks < conceal - 1) {
                        clicks++;
                      } else {
                        demodrawer.selectAll("button")
                                  .property("disabled", true);
                      }
                    });
    };
    var dodemosequence = function(sequence) {
      var inter = 200;
      var prefix = setInterval(function() {
        if (203 - inter === 0) {
          clearInterval(prefix);
          // this callback is demointerrupt
          demointerrupt(_.range(demo_syl_code.length));
        }
        else {
          var syl = sequence.shift();
          inter = inter + 1;
          demoshowsyl(sbubble);
        }
      }, 500);
      return prefix;
    };
    var el = d3.select(".elephant");
    var sbubble = d3.select(".stim");
    var rbubble = d3.select(".response");
    var conceal = 3;
    var demo_syl_code = ["wao", "yai", "piu", "shin", "bam", "fei", "ti", "ra", "ki"];
    el.on("click", function() {
      setTimeout(function() {
        var seq = [1,2,3,2,1,2,3];
        _.each(seq, _.partial(demodrawsyl, sbubble));
        demoshowbubble(sbubble);
        dodemosequence(seq);
      }, 500)
    });
  </script>
</div>
